<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>越狱开发历程（3）——第一个Tweak | 不掏蜂窝的熊</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">越狱开发历程（3）——第一个Tweak</h1><a id="logo" href="/.">不掏蜂窝的熊</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">越狱开发历程（3）——第一个Tweak</h1><div class="post-meta">Oct 10, 2012<span> | </span><span class="category"><a href="/categories/学而后思/">学而后思</a></span></div><div class="post-content"><p>BigBoss有一个分类，称之为Tweaks。网上所说得越狱插件，大多可归类与此。至于tweak这个名称的由来以及含义，由于接触得晚，完全不知其所以然。若有朋友对此熟悉，还请不吝赐教。</p>
<h2 id="Tweak"><a href="#Tweak" class="headerlink" title="Tweak"></a>Tweak</h2><p>Tweak开发，离不开的是MobielSubstrate。按百科上所讲的 ，MobieSubstrate是一个允许第三方开发者在运行时（run-time）替换扩展iOS 上系统方法的框架，主要包含了三个组件：MobileHooker，MobileLoader以及safe mode。MobielSubstrate由Saurik开发。假如不知道Saurik是哪位大神，开句外国式的玩笑，stop reading this！</p>
<h3 id="MobileHooker"><a href="#MobileHooker" class="headerlink" title="MobileHooker"></a>MobileHooker</h3><p>“钩子”这个名称可谓形象。它的作用就是，在运行时替代Objective-C消息（由于动态特性，Objective-C一般都用“消息”来指代“方法”）的实现。简单来讲，就是系统向某个类发送消息（objc_msgSend）时，会被“钩住”，并用自己的实现方法代替（是否执行系统实现方法以及执行时机可由自己决定）。</p>
<p><a href="http://www.iphonedevwiki.net/index.php/MobileSubstrate" target="_blank" rel="noopener"> 代码</a>如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> IMP original_UIView_setFrame_; <span class="comment">//声明origin的方法，也就是原有的系统方法</span></span><br><span class="line"><span class="keyword">void</span> replaced_UIView_setFrame_(<span class="built_in">UIView</span>* <span class="keyword">self</span>, SEL _cmd, <span class="built_in">CGRect</span> frame) &#123;<span class="comment">// 原有的系统方法被替换如下</span></span><br><span class="line"><span class="built_in">CGRect</span> originalFrame = <span class="keyword">self</span>.frame;</span><br><span class="line"><span class="built_in">NSLog</span>(&amp;quot;Changing frame of %p from %@ to %@&amp;quot;, <span class="keyword">self</span>, <span class="built_in">NSStringFromCGRect</span>(originalFrame), <span class="built_in">NSStringFromCGRect</span>(frame));</span><br><span class="line">original_UIView_setFrame_(<span class="keyword">self</span>, _cmd, frame); <span class="comment">// 原有的系统方法被调用</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MSHookMessageEx([<span class="built_in">UIView</span> <span class="keyword">class</span>], <span class="keyword">@selector</span>( setFrame: ), (IMP)replaced_UIView_setFrame_, (IMP*)&amp;amp;amp;original_UIView_setFrame_); <span class="comment">// 声明需要“HOOK”的类和消息名</span></span><br><span class="line"></span><br><span class="line">myView.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">100</span>); <span class="comment">//当UIView的 - setFrame 被调用时，会被替代并输出一句系统log。[/cpp]</span></span><br></pre></td></tr></table></figure>
<p>当然，最后一句也可以写成</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">original_UIView_setFrame_(<span class="keyword">self</span>, _cmd, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>));</span><br></pre></td></tr></table></figure>
<p>或者直接注销掉。不过强烈建议不要尝试。只想说的是，替代原有方法绝不是输出一句log那么简单，可以做的事情远超乎想象。</p>
<p>类方法的“钩子”的声明，需要修改如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MSHookMessageEx(objc_getMetaClass(&amp;quot;<span class="built_in">UIView</span>&amp;quot;), <span class="keyword">@selector</span>(commitAnimations), replaced_UIView_commitAnimations, (IMP*)&amp;amp;amp;original_UIView_commitAnimations);</span><br></pre></td></tr></table></figure>
<h3 id="MobileLoader"><a href="#MobileLoader" class="headerlink" title="MobileLoader"></a>MobileLoader</h3><p>“钩子”需要在运行时被加载，靠的就是MobileLoader的功劳。MobileLoader会在适当的时机加载/Library/MobileSubstrate/DynamicLibraries/目录下的动态库（.dylib，这是tweak的最终产品）。当.dylib被加载时，下面的语句会被最先调用：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((constructor))staticvoid initialize() &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打开/Library/MobileSubstrate/DynamicLibraries/，可以看到每一个.dylib都有会一个同名的.plist。.plist的作用就是用来限制.dylib的加载范围的，包括iOS版本和被加载对象的bundleID。</p>
<h3 id="safe-mode"><a href="#safe-mode" class="headerlink" title="safe mode"></a>safe mode</h3><p>看了MobileHooker的大概原理，可以猜出这东西是多么不安全。safe mode算是个保险，当SpirngBoard崩溃时会自动进入安全模式，同时仅用所有.dylib的加载。</p>
<p>至于MobilSubstrate的原理，个人觉得和Objective-C的动态特性关系密切。关于这方面，可以参考<a href="http://www.apple.com.cn/developer/mac/library/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Introduction/chapter_1_section_1.html#//apple_ref/doc/uid/TP40008048-CH1-SW1" target="_blank" rel="noopener">这里</a>。</p>
<h2 id="iOSOpenDev"><a href="#iOSOpenDev" class="headerlink" title="iOSOpenDev"></a>iOSOpenDev</h2><p>假如按照上面的语法来开发Tweak，语句实在发杂繁琐。网上由各种各样的模板，像iOSOpenDev，就内置了两种Tweak模板:CaptainHook Tweak和Logos Tweak。CaptainHook Tweak模板使用了大量宏定义来简化格式，而Logos Tweak则走得更远。初期建议用原生的语法或者CaptainHook Tweak之类的模板。在熟悉了相关的原理和语法之后，强烈建议在实际开发中使用Logos Tweak模板。</p>
<p>使用iOSOpenDev新建一个Logos Tweak工程，目录结构如下：</p>
<p>Package目录是deb包的相关东西，稍微了解deb包结构的人应该很熟悉。打开control，有这么一句：Depends:mobilesubstrate。说明Tweak开发是必须依赖mobilesubstrate这个框架的。</p>
<p>Products目录里面的.dylib就是最终产品了，是一个动态库。</p>
<p>.xm文件是我们敲代码的地方（不是.mm）。按照.xm的提示，先链接libsubstrate.dylib，然后按照Logos Tweak模板格式编写tweak，如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">id</span> __sb = <span class="literal">nil</span>;</span><br><span class="line">%hook SpringBoard  <span class="comment">//需要hook的类名</span></span><br><span class="line">-(<span class="keyword">void</span>)applicationDidFinishLaunching: (<span class="keyword">id</span>)application  <span class="comment">//需要hook的消息名</span></span><br><span class="line">&#123;</span><br><span class="line">　　%orig; <span class="comment">//执行原方法</span></span><br><span class="line">　　<span class="built_in">UIAlertView</span> *alert = [[<span class="built_in">UIAlertView</span> alloc] initWithTitle:@&amp;quot;Welcome&amp;quot; message:@&amp;quot;Welcome to your iPhone Brandon!&amp;quot; delegate:<span class="keyword">self</span> cancelButtonTitle:@&amp;quot;Thanks&amp;quot; otherButtonTitles:<span class="literal">nil</span>];</span><br><span class="line">　　[alert show];</span><br><span class="line">　　[alert release];</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">id</span>)init</span><br><span class="line">&#123;</span><br><span class="line">    __sb = <span class="keyword">self</span>;</span><br><span class="line">    <span class="keyword">return</span> %orig;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)alertView: (<span class="built_in">UIAlertView</span> *)alertView clickedButtonAtIndex: (<span class="built_in">NSInteger</span>)buttonIndex</span><br><span class="line">&#123;</span><br><span class="line">　　<span class="comment">//[__sb relaunchSpringBoard];</span></span><br><span class="line">&#125;</span><br><span class="line">%new( @@: )</span><br><span class="line">+ (<span class="keyword">id</span>)sharedBoard</span><br><span class="line">&#123;</span><br><span class="line">　　<span class="keyword">return</span> __sb;</span><br><span class="line">&#125;</span><br><span class="line">%end  <span class="comment">//结束标志</span></span><br></pre></td></tr></table></figure>
<p>编译一下，然后打开.mm文件，可以看到Logos Tweak的脚本已经自动将.xm文件中Logos格式的语句转化为我们熟悉的符合mobilesubstrate语法的语句了，使用了类似于CaptainHook的宏定义。每次编译.xm文件都会自动覆盖.mm文件，所以，除了了解一些实现原理外，可基本忽略.mm文件。</p>
<p>而Logos Tweak的这种类似于类定义的语法，看着确实让人舒服，同时也可实实在在地提高开发速度。</p>
<p>%hook Classname：需要“hook”某个类的起始标志</p>
<p>%new：插入新方法到类中</p>
<p>%end：“hook”某个类的结束标志</p>
<p>%orig或者%orig（args）：执行系统方法，若有参数可带参数</p>
<p>%c(Class):其实就是objc_getClass（）</p>
<p>%log：快速打印类、消息名以及参数到系统log中</p>
<p>%ctor｛…｝：其实就是</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((constructor))staticvoid initialize()&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>这个入口函数。</p>
<p>还有很多，可以查看<a href="http://www.iphonedevwiki.net/index.php/Logos" target="_blank" rel="noopener">这里</a></p>
<p>前面那段代码其实算是Tweak的HelloWorld吧，其实就是在SpringBoard启动时弹出一个对话框（被注销掉的代码是临时加的，可以尝试去掉看看效果）。将.dylib和.plist拷贝出来复制到/Library/MobileSubstrate/DynamicLibraries/目录下（由于没有打deb包，请确认手机已经安装了MobilSubstrate），重启SpringBoard，假如启动后弹出了一个对话框，说明tweak成功了。Hello world！</p>
</div><div class="tags"><a href="/tags/iOS/">iOS</a><a href="/tags/越狱开发/">越狱开发</a></div><div class="post-nav"><a class="pre" href="/2012/12/04/e8-b6-8a-e7-8b-b1-e5-bc-80-e5-8f-91-e5-8e-86-e7-a8-8b-ef-bc-884-ef-bc-89-e7-bb-93/">越狱开发历程（4）——结</a><a class="next" href="/2012/09/19/e8-b6-8a-e7-8b-b1-e5-bc-80-e5-8f-91-e5-8e-86-e7-a8-8b-ef-bc-882-ef-bc-89-e5-bc-80-e5-8f-91-e7-8e-af-e5-a2-83-e6-90-ad-e5-bb-ba/">越狱开发历程（2）——开发环境搭建</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://hotobear.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/学而后思/">学而后思</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活点滴/">生活点滴</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/调色板/">调色板</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/动画/" style="font-size: 15px;">动画</a> <a href="/tags/AKB48/" style="font-size: 15px;">AKB48</a> <a href="/tags/一吻定情/" style="font-size: 15px;">一吻定情</a> <a href="/tags/偶像/" style="font-size: 15px;">偶像</a> <a href="/tags/焦虑/" style="font-size: 15px;">焦虑</a> <a href="/tags/驾校/" style="font-size: 15px;">驾校</a> <a href="/tags/猎豹浏览器/" style="font-size: 15px;">猎豹浏览器</a> <a href="/tags/熊本熊/" style="font-size: 15px;">熊本熊</a> <a href="/tags/城市物种日历/" style="font-size: 15px;">城市物种日历</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/tags/iOS调试技巧/" style="font-size: 15px;">iOS调试技巧</a> <a href="/tags/阶段总结/" style="font-size: 15px;">阶段总结</a> <a href="/tags/梶浦由记香港演唱会/" style="font-size: 15px;">梶浦由记香港演唱会</a> <a href="/tags/iOS-7/" style="font-size: 15px;">iOS 7</a> <a href="/tags/Safari/" style="font-size: 15px;">Safari</a> <a href="/tags/越狱开发/" style="font-size: 15px;">越狱开发</a> <a href="/tags/博客日志/" style="font-size: 15px;">博客日志</a> <a href="/tags/iOS-8/" style="font-size: 15px;">iOS 8</a> <a href="/tags/WebKit/" style="font-size: 15px;">WebKit</a> <a href="/tags/游戏/" style="font-size: 15px;">游戏</a> <a href="/tags/React-Native/" style="font-size: 15px;">React Native</a> <a href="/tags/iOS-9/" style="font-size: 15px;">iOS 9</a></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">不掏蜂窝的熊.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>